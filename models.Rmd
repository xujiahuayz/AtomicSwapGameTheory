---
title: "Plots"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=F}
library(tikzDevice)
library(magrittr)
library(knitr)
library(data.table)
library(ggplot2)
library(shiny)
library(shinythemes)
library(dplyr)
library(readr)
library(mvtnorm)
library(VGAM)
library(sampleSelection)
library(rootSolve)
library(plotly)

opts_chunk$set(#dev='tikz', 
               fig.path='./figure/', 
               echo=F, error=F, cache=F, message=F, warning=F,
               # results='hide', 
               autodep=T,
               fig.height = 6)

options(stringsAsFactors = F)


par(mar = c(0.5,0.5,0,0), oma = c(1,1,1,0), mgp = c(0.5, 0, 0), cex.axis=.9, cex = 2)
```

```{r parameters, include=F}
alphas = c(0.2, 0.2) # agent 1 or 2
rs = c(0.01, 0.01) # agent 1 or 2

mu = 0.002
sigma = 0.1
taua = 3
taub = 4
taueps = 1
pt1 = 2 #current price is given, but strike price is to be negotiated

P0s = seq(0.2,3,length.out = 999)
```

```{r functions, include=F}
# Utility function
funcutil = function(Price,Time,Suc,agent){
  (1+alphas[agent]*Suc)*Price/exp(rs[agent]*Time)
}

# Brownian motion PDF
funcgbmpdf = function(x, Price, Time){
  exp(-(
   2 * log(x/Price) - (2*mu-sigma^2)*Time
  )^2/(8*sigma^2*Time)
  )/(
    sqrt(2*pi*Time)*x*sigma
    )
}

# Brownian motion CDF
funcgbmcdf = function(x, Price, Time){
  erfc( # complementary error function erfc
    (log(Price/x)+(mu-sigma^2/2)*Time)/(sqrt(2*Time)*sigma)
    )/2
}

# Price = 2
# Time = 2
# x = seq(0, 4, 0.01)
# plot(x, funcgbmpdf(x, Price, Time), type = 'l') # checked with mathematica
# plot(x, funcgbmcdf(x, Price, Time), type = 'l') # checked with mathematica


# price lower bound for Alice
pt3thresh = function(P0){
  P0/(
  (1+alphas[1])*exp((mu-rs[1])*taub+rs[1]*(taua+taueps))
)
}

# expected utility for Bob if continue
funcoptButil2 = function(x, P0){
  # probability to be lower than lower bound 
  p = funcgbmcdf(pt3thresh(P0), x, taub)
  (1-p)*funcutil(
    P0,taua+taueps,1,2
    )+p*funcutil(
      x*exp(2*mu*taub),2*taub,0,2
      )
}

funcpt2thresh = function(x, P0){
funcoptButil2(x, P0)- x
}

pt2threshs = function(P0){
  tempfunc = function(x){funcpt2thresh(x, P0)}
  uniroot.all(tempfunc, lower = 0.01, upper = 999, maxiter = 99999, n = 9999)
}

funcoptAutil = function(pt3vs){
  funcutil(
  pt3vs*exp(mu*taub),taub,1,1)
}

# utility of Alice at t_3 if withdraw
opt2A = function(P0){
  funcutil(P0,taua+taueps,0,1)
}


funcAutil2 = function(pt2, P0){
  pt3threshv = pt3thresh(P0)
  temp = function(pt3){
    funcgbmpdf(pt3, pt2, taub) * funcoptAutil(pt3)
  }
  funcgbmcdf(pt3threshv, pt2, taub) * opt2A(P0) + integrate(temp, pt3threshv, Inf, abs.tol = 0)$value
}

# P0 = P0s[42]
funcAutilcontinue = function(P0){
  temp = function(pt2){
    funcgbmpdf(pt2, pt1, taua) * funcAutil2(pt2,P0)
  }
  pt2threshv = pt2threshs(P0)
  
  # gives terribly wrong answer if omitting abs.tol
  utilt3 = integrate(Vectorize(temp), pt2threshv[1], pt2threshv[2], abs.tol = 0)$value
  
  probBobwaive = 1-funcgbmcdf(pt2threshv[2], P0, taua) + funcgbmcdf(pt2threshv[1], P0, taua)
  utilt3/exp(rs[1]*(taua+taub))+probBobwaive*P0/exp(rs[1]*(2*taua+taub))
}


funcsuccessrate = function(P0){
  pt3threshv = pt3thresh(P0)
  temp = function(pt2){
    funcgbmpdf(pt2, pt1, taua) * funcgbmcdf(pt3threshv, pt2, taub)
  }
  pt2threshv = pt2threshs(P0)
  
  # gives terribly wrong answer if omitting abs.tol
  integrate(Vectorize(temp), pt2threshv[1], pt2threshv[2], abs.tol = 0)$value
}

# P0 = P0s[41]
# pt2threshv = pt2threshs(P0)
# vs = seq(pt2threshv[1],pt2threshv[2], length.out = 9999)
# df = data.table(x=vs, y=Vectorize(temp)(vs))
# 
# (df$y %>% sum)*diff(pt2threshv)/9999
# temp = function(pt2){
#     funcgbmpdf(pt2, pt1, taua) * funcAutil2(pt2,P0)
# }
# 
# integrate(Vectorize(temp), pt2threshv[1], pt2threshv[2],abs.tol = 0)$value

```

```{r plots, include=F, eval=F}

for(P0 in c(1.5, 2, 2.5)){
  par(mar = c(2,2,2,0), oma = c(1,1,0,0), mgp = c(1, 0, 0), cex.axis=.9, cex = 1.7, tck = -0.01)
  pt3threshv = pt3thresh(P0)
  
  pt3vs1 = seq(1e-10,pt3threshv,length.out = 200)
  pt3vs2 = seq(pt3threshv, 5,length.out = 200)
  
  pt3vs = c(pt3vs1, pt3vs2)
  
  plot(pt3vs, funcoptAutil(pt3vs), type = 'l', 
       xlab = 'Price at t3', ylab = "Alice's utility at t3", 
       col = 'chartreuse3', main = paste('P0 =', P0))
  
  opt2Av = opt2A(P0)
  lines(pt3vs, rep(opt2Av, length(pt3vs)))
  
  points(pt3threshv, opt2Av, pch = '.', col = 'red', cex = 5)
  
  legend('topleft', lty = c(1,1,NA), 
         pch = c(NA, NA, '.'),
         pt.cex = 5,
         col = c('chartreuse3', 'black', 'red'), 
         legend = c('continue', 'withdraw', 'Price lower bound at t3'))
  
  # 
  # lines(pt3vs, c(
  # rep(opt2Av, length(pt3vs1)),
  # funcoptAutil(pt3vs2)
  # ), col = 'chartreuse3', cex = 2)
  
  
  pt2s = c(1, 2, 3)
  
  plot(pt3vs, funcgbmpdf(pt3vs, pt2s[1], taub), type = 'l', 
       xlab = 'Price at t3', 
       ylab = 'Density', lty = 2, main = paste('P0 =', P0))
  lines(pt3vs, funcgbmpdf(pt3vs, pt2s[2], taub), lty = 1)
  lines(pt3vs, funcgbmpdf(pt3vs, pt2s[3], taub), lty = 3)
  
  abline(v = pt3threshv, col = 'red')
  
  legend('topright', lty = c(2,1,3), 
         legend = pt2s,
         title = 'Price at t2')
  
  
  pt2vs = seq(1e-10,5,length.out = 200)
  
  pt2threshsv = pt2threshs(P0)
  
  plot(pt2vs, pt2vs, type = 'l', 
       xlab = 'Price at t2', ylab = "Bob's utility at t2", main = paste('P0 =', P0))
  lines(pt2vs, funcoptButil2(pt2vs, P0), col = 'chartreuse3')
  points(pt2threshsv[1], pt2threshsv[1], pch = '.', col = 'red', cex = 5)
  points(pt2threshsv[2], pt2threshsv[2], pch = '.', col = 'blue', cex = 5)
  
  legend('topleft', lty = c(1,1, NA, NA), 
         pch = c(NA, NA, '.', '.'),
         pt.cex = 5,
         col = c('chartreuse3', 'black', 'red', 'blue'), 
         legend = c('continue', 'withdraw', 'Price lower bound at t2', 'Price upper bound at t2'))
  
  plot(pt2vs, funcgbmpdf(pt2vs, pt1, taua), type = 'l',
       xlab = 'Price at t2', ylab = 'Density', main = paste('P0 =', P0))
  abline(v = pt2threshsv, col = c('red', 'blue'))
}

# utilA0=c()
# for (P0 in P0s){
#   utilA0 = c(utilA0, funcAutilcontinue(P0))
# }

utilA0 = Vectorize(funcAutilcontinue)(P0s)

plot(c(0,max(P0s)),c(0,max(P0s)),type = 'l', 
       xlab = 'Swap price P0', ylab = "Alice's utility at t1")
lines(P0s, utilA0, col = 'chartreuse3')

p0boundsind = which(diff(P0s-utilA0 <0)!=0)
points(P0s[p0boundsind], P0s[p0boundsind], col = c('red','blue'), pch = '.', cex = 5)

abline(v = pt1, lty =2)
text(x=pt1, y =0, 'Price at t1')

legend('topleft', lty = c(1,1, NA, NA), 
         pch = c(NA, NA, '.', '.'),
         pt.cex = 5,
         col = c('chartreuse3', 'black', 'red', 'blue'), 
         legend = c('continue', 'withdraw', 'Swap price lower bound ', 'Swap price upper bound'))


```

```{r tauas, include=F, eval = F}
sigma = 0.1

par(mar = c(2,2,0,0), oma = c(1,1,0,0), mgp = c(1, 0, 0), cex.axis=.9, cex = 1.7, tck = -0.01)

plot(c(0,max(P0s)),c(0,max(P0s)),type = 'l', 
       xlab = 'Swap price P0', ylab = "Alice's utility at t1")

tauas = c(0.5, 3, 5.5)
ltys = c(2,1,3)
for (i in 1:3){
taua = tauas[i]
utilA0 = Vectorize(funcAutilcontinue)(P0s)
lines(P0s, utilA0, col = 'chartreuse3', lty = ltys[i])

p0boundsind = which(diff(P0s-utilA0 <0)!=0)
points(P0s[p0boundsind], P0s[p0boundsind], col = c('red','blue'), pch = '.', cex = 5)

}


abline(v = pt1, lty =2)
text(x=pt1, y = 0, 'Price at t1')

legend('topleft', lty = ltys, 
         col = c('chartreuse3'), 
         legend = tauas,
       title = "tau_a")
```

```{r taubs, include=F, eval = F}
sigma = 0.1

par(mar = c(2,2,0,0), oma = c(1,1,0,0), mgp = c(1, 0, 0), cex.axis=.9, cex = 1.7, tck = -0.01)

plot(c(0,max(P0s)),c(0,max(P0s)),type = 'l', 
       xlab = 'Swap price P0', ylab = "Alice's utility at t1")

taubs = c(0.5, 4, 7.5)
ltys = c(2,1,3)
for (i in 1:3){
taub = taubs[i]
utilA0 = Vectorize(funcAutilcontinue)(P0s)
lines(P0s, utilA0, col = 'chartreuse3', lty = ltys[i])

p0boundsind = which(diff(P0s-utilA0 <0)!=0)
points(P0s[p0boundsind], P0s[p0boundsind], col = c('red','blue'), pch = '.', cex = 5)

}


abline(v = pt1, lty =2)
text(x=pt1, y = 0, 'Price at t1')

legend('topleft', lty = ltys, 
         col = c('chartreuse3'), 
         legend = taubs,
       title = "tau_b")
```

```{r sigmas, include=F, eval = T}
taua = 3
taub = 4

sigmas = c(0.06, 0.1, 0.14)

utilA0s = list()
validp0s = list()
sucrates = list()

for (i in 1:3){
sigma = sigmas[i]
utilA0 = Vectorize(funcAutilcontinue)(P0s)
utilA0s[[i]] = utilA0
p0boundsind = which(diff(P0s-utilA0 <0)!=0)

validp0 = seq(P0s[p0boundsind[1]], P0s[p0boundsind[2]], length.out = 999)
validp0s[[i]] = validp0
sucrates[[i]] = Vectorize(funcsuccessrate)(validp0)
}


par(mar = c(2,2,0,0), oma = c(1,1,0,0), mgp = c(1, 0, 0), cex.axis=.9, cex = 1.7, tck = -0.01)

plot(c(0,max(P0s)),c(0,max(P0s)),type = 'l', 
       xlab = 'Swap price P0', ylab = "Alice's utility at t1")


ltys = c(2,1,3)
for (i in 1:3){
lines(P0s, utilA0s[[i]], col = 'chartreuse3', lty = ltys[i])
points(validp0s[[i]] %>% range, validp0s[[i]] %>% range, col = c('red','blue'), pch = '.', cex = 5)
}

abline(v = pt1, lty =2)
text(x=pt1, y = 0, 'Price at t1')

legend('topleft', lty = ltys, 
         col = c('chartreuse3'), 
         legend = sigmas,
       title = "sigma")


plot(NULL, xlim = c(0,max(P0s)),ylim = c(0,1),
       xlab = 'Swap price P0', ylab = "Success rate")

sigmas = c(0.06, 0.1, 0.14)
ltys = c(2,1,3)

for (i in 1:3){
lines(validp0s[[i]], sucrates[[i]], col = 'chartreuse3', lty = ltys[i])
}

legend('topleft', lty = ltys, 
         col = c('chartreuse3'), 
         legend = sigmas,
       title = "sigma")
```


```{r alphas, include=F, eval=F}
sigma = 0.1

par(mar = c(2,2,0,0), oma = c(1,1,0,0), mgp = c(1, 0, 0), cex.axis=.9, cex = 1.7, tck = -0.01)

plot(c(0,max(P0s)),c(0,max(P0s)),type = 'l', 
       xlab = 'Swap price P0', ylab = "Alice's utility at t1")

a1s = c(0.1, 0.2, 0.3)
ltys = c(2,1,3)
for (i in 1:3){
alphas[1] = a1s[i]
utilA0 = Vectorize(funcAutilcontinue)(P0s)
lines(P0s, utilA0, col = 'chartreuse3', lty = ltys[i])

p0boundsind = which(diff(P0s-utilA0 <0)!=0)
points(P0s[p0boundsind], P0s[p0boundsind], col = c('red','blue'), pch = '.', cex = 5)

}


abline(v = pt1, lty =2)
text(x=pt1, y =0, 'Price at t1')

legend('topleft', lty = ltys, 
         col = c('chartreuse3'), 
         legend = a1s,
       title = "Alice's alpha")
```


```{r rs, include=F, eval=F}
alphas[1] = 0.2

par(mar = c(2,2,0,0), oma = c(1,1,0,0), mgp = c(1, 0, 0), cex.axis=.9, cex = 1.7, tck = -0.01)

plot(c(0,max(P0s)),c(0,max(P0s)),type = 'l', 
       xlab = 'Swap price P0', ylab = "Alice's utility at t1")

r1s = c(0.001, 0.01, 0.05)
ltys = c(2,1,3)
for (i in 1:3){
rs[1] = r1s[i]
utilA0 = Vectorize(funcAutilcontinue)(P0s)
lines(P0s, utilA0, col = 'chartreuse3', lty = ltys[i])

p0boundsind = which(diff(P0s-utilA0 <0)!=0)
points(P0s[p0boundsind], P0s[p0boundsind], col = c('red','blue'), pch = '.', cex = 5)

}


abline(v = pt1, lty =2)
text(x=pt1, y =0, 'Price at t1')

legend('topleft', lty = ltys, 
         col = c('chartreuse3'), 
         legend = a1s,
       title = "Alice's r")
```